<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reconnaissance d'√âtiquettes - OCR Ingr√©dients</title>
  <meta name="theme-color" content="#4b6cb7"/>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .container{background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);width:100%;max-width:980px;overflow:hidden}
    header{background:linear-gradient(90deg,#4b6cb7 0%,#182848 100%);color:#fff;padding:24px;text-align:center}
    h1{font-size:2rem;margin-bottom:6px}
    .subtitle{opacity:.9}
    .main-content{padding:22px}
    .upload-section{text-align:center;margin-bottom:24px}
    .upload-area{border:3px dashed #4b6cb7;border-radius:15px;padding:28px 16px;cursor:pointer;transition:.2s;background:#f8f9ff;margin-bottom:16px}
    .upload-area:hover{background:#eef1ff;transform:translateY(-2px)}
    .upload-icon{font-size:2.4rem;color:#4b6cb7;margin-bottom:8px}
    .upload-text{font-size:1rem;color:#333;margin-bottom:10px}
    .btn{border:none;border-radius:999px;padding:10px 18px;font-weight:600;cursor:pointer;transition:.2s}
    .btn-primary{background:linear-gradient(90deg,#4b6cb7 0%,#182848 100%);color:#fff;box-shadow:0 5px 15px rgba(75,108,183,.4)}
    .btn-outline{background:#f8f9ff;color:#4b6cb7;border:2px solid #4b6cb7}
    .btn:hover{transform:translateY(-2px)}
    #file-input{display:none}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .preview-section{display:none;margin-bottom:18px}
    .preview-title{text-align:center;color:#182848;margin-bottom:10px}
    .image-preview{width:100%;max-height:360px;object-fit:contain;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
    .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
    .loading{display:none;text-align:center;margin:18px 0}
    .spinner{border:5px solid #f3f3f3;border-top:5px solid #4b6cb7;border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite;margin:0 auto 12px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:14px}
    .results-section{display:none}
    .results-title{text-align:center;color:#182848;margin:6px 0 12px}
    .ingredients-list{list-style:none;background:#f8f9ff;border-radius:10px;padding:10px}
    .ingredient-item{display:flex;align-items:center;gap:10px;padding:10px 8px;border-bottom:1px solid #e9e9ee}
    .ingredient-item:last-child{border-bottom:none}
    .pill{font-size:.75rem;padding:2px 8px;border-radius:999px;border:1px solid #ddd}
    .pill-allergen{border-color:#b40000;color:#b40000;background:#ffe9e9}
    .pill-maybe{border-color:#8a7600;color:#8a7600;background:#fff7d6}
    .actions{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:16px}
    footer{text-align:center;padding:14px;color:#666;font-size:.9rem;border-top:1px solid #eee}
    label{font-weight:600;color:#182848;margin-bottom:6px;display:block}
    input[type="text"],select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
    .small{font-size:.9rem;color:#666;margin-top:6px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}h1{font-size:1.6rem}.main-content{padding:16px}}
  </style>
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
<div class="container">
  <header>
    <h1>Reconnaissance d'√âtiquettes</h1>
    <p class="subtitle">OCR des ingr√©dients + d√©tection du produit (type, nom, sous-type) ‚Ä¢ fonctionne hors-ligne</p>
  </header>

  <div class="main-content">
    <div class="upload-section card">
      <div class="upload-area" id="upload-area">
        <div class="upload-icon">üì∑</div>
        <p class="upload-text">Glissez-d√©posez une image ici ou cliquez pour s√©lectionner</p>
        <div class="controls">
          <button class="btn btn-primary" id="pick-btn">S√©lectionner une image</button>
          <button class="btn btn-outline" id="camera-btn">Prendre une photo</button>
        </div>
        <input type="file" id="file-input" accept="image/*" />
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="preview-section" id="preview-section">
          <h2 class="preview-title">Aper√ßu</h2>
          <img id="image-preview" class="image-preview" alt="Aper√ßu de l'image">
          <video id="camera-preview" class="image-preview" style="display:none" autoplay playsinline></video>
          <div class="controls">
            <button class="btn btn-primary" id="analyze-btn">Analyser l‚Äôimage</button>
            <button class="btn btn-outline" id="reset-btn">R√©initialiser</button>
          </div>
        </div>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p class="loading-text" id="loading-text">OCR en cours‚Ä¶</p>
        </div>

        <div class="results-section" id="results-section">
          <h2 class="results-title">Ingr√©dients identifi√©s</h2>
          <ul class="ingredients-list" id="ingredients-list"></ul>
          <div class="actions">
            <button class="btn btn-outline" id="copy-btn">Copier la liste</button>
            <button class="btn btn-outline" id="csv-btn">Exporter CSV</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="preview-title">Produit</h2>
        <label for="productType">Cat√©gorie</label>
        <select id="productType">
          <option value="">-- d√©tecter automatiquement --</option>
          <option value="biere">Bi√®re</option>
          <option value="vin">Vin</option>
          <option value="champagne">Champagne</option>
        </select>

        <label for="productName" style="margin-top:10px;">Nom / Marque</label>
        <input type="text" id="productName" placeholder="ex: Chimay Grande R√©serve">

        <label for="productSubType" style="margin-top:10px;">Sous-type</label>
        <input type="text" id="productSubType" placeholder="ex: IPA / Blonde / Rouge / Ros√© / Blanc">

        <div class="small">Ces champs se remplissent automatiquement apr√®s l‚ÄôOCR (si possible), et tu peux corriger manuellement.</div>

        <div class="actions" style="justify-content:flex-start;margin-top:12px">
          <button class="btn btn-primary" id="export-json">Exporter JSON</button>
        </div>

        <textarea id="json-output" rows="10" style="margin-top:10px" placeholder="Sortie JSON..."></textarea>
      </div>
    </div>
  </div>

  <footer>
    <p>Appli PWA : installable, fonctionne hors-ligne. OCR c√¥t√© navigateur, aucune image envoy√©e.</p>
  </footer>
</div>

<script>
(function(){
  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('file-input');
  const pickBtn = document.getElementById('pick-btn');
  const cameraBtn = document.getElementById('camera-btn');
  const imagePreview = document.getElementById('image-preview');
  const cameraPreview = document.getElementById('camera-preview');
  const previewSection = document.getElementById('preview-section');
  const analyzeBtn = document.getElementById('analyze-btn');
  const resetBtn = document.getElementById('reset-btn');
  const loading = document.getElementById('loading');
  const loadingText = document.getElementById('loading-text');
  const resultsSection = document.getElementById('results-section');
  const ingredientsList = document.getElementById('ingredients-list');
  const copyBtn = document.getElementById('copy-btn');
  const csvBtn = document.getElementById('csv-btn');
  const exportBtn = document.getElementById('export-json');
  const jsonOutput = document.getElementById('json-output');

  const productType = document.getElementById('productType');
  const productName = document.getElementById('productName');
  const productSubType = document.getElementById('productSubType');

  const ALLERGENES = [
    "gluten","lait","lactose","≈ìuf","oeuf","arachide","soja",
    "noisette","amande","noix","noix de cajou","pistache","noix de p√©can",
    "sulfites","crustac√©","crustac√©s","moutarde","c√©leri","graines de s√©same",
    "s√©same","lupin","poisson","mollusque","mollusques"
  ];

  // Heuristiques de d√©tection produit
  const KEYS_PRODUCT = {
    biere: [/bi[e√®]re\b/i, /\bbier\b/i, /\bbeer\b/i, /\bipa\b/i, /\bstout\b/i, /\bblonde\b/i, /\bbrune\b/i, /\btriple\b/i, /\bweiss\b/i, /\bwheat\b/i, /\blager\b/i, /\bpils?\b/i],
    vin: [/\bvin\b/i, /\bappellation\b/i, /\baoc\b/i, /\bigt?\b/i, /\bIGP\b/i, /\bAOP\b/i, /\bch[√¢a]teau\b/i, /\bc[√©e]pages?\b/i],
    champagne: [/\bchampagne\b/i, /\bmaison\b/i, /\bgrand cru\b/i, /\bbrut\b/i, /\bblanc de blancs\b/i]
  };
  const KEYS_SUBTYPE = {
    biere: [ ["ipa",/\bipa\b/i], ["blonde",/\bblonde\b/i], ["brune",/\bbrune\b/i], ["ambree",/\bambr[√©e]e?\b/i], ["stout",/\bstout\b/i], ["triple",/\btriple\b/i], ["pale ale",/\bpale ale\b/i] ],
    vin: [ ["rouge",/\brouge\b/i], ["ros√©",/\bros[√©e]\b/i], ["blanc",/\bblanc\b/i], ["moelleux",/\bmoelleux\b/i], ["sec",/\bsec\b/i] ],
    champagne: [ ["brut",/\bbrut\b/i], ["extra brut",/\bextra\s+brut\b/i], ["ros√©",/\bros[√©e]\b/i], ["blanc de blancs",/\bblanc de blancs\b/i], ["demi-sec",/\bdemi-?sec\b/i] ]
  };

  let stream = null;
  let currentImageBlobUrl = "";

  // SW registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(console.error);
    });
  }

  // Entr√©e
  pickBtn.addEventListener('click', () => fileInput.click());
  uploadArea.addEventListener('click', () => fileInput.click());
  uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.background = '#eef1ff'; });
  uploadArea.addEventListener('dragleave', () => { uploadArea.style.background = '#f8f9ff'; });
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault(); uploadArea.style.background = '#f8f9ff';
    if(e.dataTransfer.files.length){ handleFile(e.dataTransfer.files[0]); }
  });
  fileInput.addEventListener('change', (e) => { if(e.target.files.length){ handleFile(e.target.files[0]); } });

  // Cam√©ra
  document.getElementById('camera-btn').addEventListener('click', async() => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      cameraPreview.srcObject = stream;
      cameraPreview.style.display = 'block';
      imagePreview.style.display = 'none';
      previewSection.style.display = 'block';
      analyzeBtn.textContent = "Capturer & Analyser";
    } catch(err){ alert("Acc√®s cam√©ra refus√© ou indisponible."); console.error(err); }
  });

  function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    cameraPreview.style.display = 'none';
    analyzeBtn.textContent = "Analyser l‚Äôimage";
  }

  function handleFile(file){
    if(!file.type.match('image.*')){ alert("Veuillez s√©lectionner une image valide."); return; }
    stopCamera();
    const url = URL.createObjectURL(file);
    currentImageBlobUrl = url;
    imagePreview.src = url;
    imagePreview.style.display = 'block';
    previewSection.style.display = 'block';
    resultsSection.style.display = 'none';
  }

  // OCR + Extraction
  analyzeBtn.addEventListener('click', async () => {
    let dataUrl = null;

    if(stream){
      loading.style.display = 'block';
      loadingText.textContent = "Capture‚Ä¶";
      const canvas = document.createElement('canvas');
      canvas.width = cameraPreview.videoWidth;
      canvas.height = cameraPreview.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
      dataUrl = canvas.toDataURL('image/png');
      imagePreview.src = dataUrl;
      imagePreview.style.display = 'block';
      stopCamera();
    } else {
      if(!imagePreview.src){ alert("Veuillez d'abord s√©lectionner une image."); return; }
      dataUrl = imagePreview.src;
    }

    try{
      loading.style.display = 'block';
      loadingText.textContent = "OCR en cours‚Ä¶";
      resultsSection.style.display = 'none';

      const worker = await Tesseract.createWorker("fra", 1, { logger: m => {} });
      const { data: { text } } = await worker.recognize(dataUrl);
      await worker.terminate();

      loadingText.textContent = "Extraction‚Ä¶" ;

      // Ingr√©dients
      const parsed = extractIngredients(text);
      renderIngredients(parsed);

      // Produit (type/nom/sous-type)
      const lines = splitLines(text);
      autoDetectProduct(lines);

      loading.style.display = 'none';
      resultsSection.style.display = 'block';
      updateJsonOutput(parsed);
    } catch(err){
      loading.style.display = 'none';
      alert("√âchec de l'OCR. Essayez une photo plus nette, bien √©clair√©e.");
      console.error(err);
    }
  });

  // Extraction ingr√©dients
  function extractIngredients(rawText){
    if(!rawText) return [];
    let text = normalizeWhitespace(rawText);
    const markers = ["ingr√©dients","ingredients","composition","ingr√©diens"];
    let startIdx = -1;
    for(const m of markers){
      const idx = text.toLowerCase().indexOf(m);
      if(idx !== -1){ startIdx = idx; break; }
    }
    if(startIdx === -1){ return cleanAndSplit(text); }
    let candidate = text.slice(startIdx);
    const stops = ["valeurs nutritionnelles","nutriments","peut contenir","traces de","conserver","allerg√®nes","allergenes"];
    for(const stop of stops){
      const si = candidate.toLowerCase().indexOf(stop);
      if(si !== -1) candidate = candidate.slice(0, si);
    }
    candidate = candidate.replace(/^.*?:/i, "");
    return cleanAndSplit(candidate);
  }
  function cleanAndSplit(segment){
    let s = segment
      .replace(/\r/g," ")
      .replace(/\n/g," ")
      .replace(/\s+/g," ")
      .replace(/\s*[‚Ä¢¬∑\*]\s*/g, ", ")
      .replace(/\s*;\s*/g, ", ")
      .replace(/\s*\.\s*/g, ", ");
    s = s.replace(/[()]/g, ",");
    let parts = s.split(/\s*,\s*/);
    parts = parts
      .map(p => p.trim())
      .filter(p => p.length>0 && p.length<80)
      .map(p => {
        let t = p.toLowerCase();
        t = t.replace(/\b\d+([.,]\d+)?\s*%/g,"")
             .replace(/\b\d+([.,]\d+)?\s*(g|mg|ml)\b/g,"")
             .replace(/\s{2,}/g," ").trim();
        t = t.replace(/^(ingr√©dients?|composition)\s*:?\s*/,"");
        return t;
      });
    const seen = new Set(), cleaned=[];
    for(const p of parts){
      const key = p.normalize('NFKC');
      if(!seen.has(key) && !/^[\W_]+$/.test(key)){ seen.add(key); cleaned.push(p); }
    }
    return cleaned;
  }
  function splitLines(text){
    return (text||"")
      .split(/\r?\n/)
      .map(l=>l.trim())
      .filter(l=>l.length>0);
  }
  function normalizeWhitespace(s){ return (s||"").replace(/\r?\n/g," ").replace(/\s{2,}/g," ").trim(); }

  // Heuristiques nom/type/sous-type
  function autoDetectProduct(lines){
    const joined = lines.join(" \n ");
    // Type
    const typeScore = { biere:0, vin:0, champagne:0 };
    for(const [type, regs] of Object.entries(KEYS_PRODUCT)){
      regs.forEach(r => { if(r.test(joined)) typeScore[type]++; });
    }
    const bestType = Object.keys(typeScore).reduce((a,b)=> typeScore[a]>=typeScore[b]?a:b);
    if(typeScore[bestType] > 0 && !productType.value) productType.value = bestType;

    // Sous-type
    let sub = "";
    const selected = productType.value || bestType;
    if(selected && KEYS_SUBTYPE[selected]){
      for(const [label, rx] of KEYS_SUBTYPE[selected]){
        if(rx.test(joined)){ sub = label; break; }
      }
    }
    if(sub && !productSubType.value) productSubType.value = capitalize(sub);

    // Nom / marque : heuristique
    // - Cherche une ligne en haut du texte, assez longue, avec majuscules/accents, sans mots-cl√©s g√©n√©riques
    const blacklist = ["ingredients","ingr√©dients","composition","valeurs","nutritionnelles","alcool","degr√©","volume","mise en bouteille","mis en bouteille"];
    let candidate = "";
    for(let i=0;i<Math.min(12, lines.length);i++){
      const L = lines[i];
      const low = L.toLowerCase();
      if(blacklist.some(b=>low.includes(b))) continue;
      if(L.length >= 5 && /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/.test(L)){
        // Pr√©f√®re Majuscules/Titre
        const score = (L === L.toUpperCase() ? 2 : 0) + (/\b[A-Z][a-z]/.test(L) ? 1 : 0) + Math.min(L.length, 40)/40;
        if(score > (candidate.score||0)){ candidate = { text: L.replace(/[\.:]+$/,"").trim(), score }; }
      }
    }
    if(candidate.text && !productName.value){ productName.value = candidate.text; }
  }

  function renderIngredients(items){
    ingredientsList.innerHTML = "";
    if(items.length === 0){
      ingredientsList.innerHTML = "<li class='ingredient-item'>Aucun ingr√©dient d√©tect√©.</li>";
      return;
    }
    items.forEach(name => {
      const li = document.createElement('li');
      li.className = 'ingredient-item';
      const allergen = ALLERGENES.find(a => name.includes(a));
      const maybeContains = /traces de/.test(name) ? "traces" : null;
      const pill = document.createElement('span');
      pill.className = 'pill';
      if(allergen){ pill.classList.add('pill-allergen'); pill.textContent = "Allerg√®ne"; }
      else if(maybeContains){ pill.classList.add('pill-maybe'); pill.textContent = "Traces possibles"; }
      else { pill.textContent = "Ingr√©dient"; }
      const span = document.createElement('span');
      span.textContent = capitalize(name);
      li.appendChild(pill);
      li.appendChild(span);
      ingredientsList.appendChild(li);
    });
  }

  function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

  // Export
  function collectIngredients(){
    return [...ingredientsList.querySelectorAll('.ingredient-item span:last-child')].map(s=>s.textContent);
  }
  document.getElementById('reset-btn').addEventListener('click', () => {
    fileInput.value = '';
    imagePreview.src = '';
    imagePreview.style.display = 'none';
    currentImageBlobUrl && URL.revokeObjectURL(currentImageBlobUrl);
    currentImageBlobUrl = "";
    previewSection.style.display = 'none';
    resultsSection.style.display = 'none';
    loading.style.display = 'none';
    stopCamera();
    productType.value = "";
    productName.value = "";
    productSubType.value = "";
    jsonOutput.value = "";
  });
  document.getElementById('copy-btn').addEventListener('click', async () => {
    const items = collectIngredients();
    if(items.length===0){ return; }
    try{
      await navigator.clipboard.writeText(items.join(', '));
      document.getElementById('copy-btn').textContent = "Copi√© !";
      setTimeout(()=>document.getElementById('copy-btn').textContent="Copier la liste",1000);
    }catch(e){ alert("Impossible de copier."); }
  });
  document.getElementById('csv-btn').addEventListener('click', () => {
    const rows = [["ingredient","type"]];
    const lis = [...ingredientsList.querySelectorAll('.ingredient-item')];
    lis.forEach(li=>{
      const name = li.querySelector('span:last-child')?.textContent || "";
      const type = li.querySelector('.pill')?.textContent || "Ingr√©dient";
      rows.push([name,type]);
    });
    const csv = rows.map(r=>r.map(escapeCsv).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = "ingredients.csv"; a.click();
    URL.revokeObjectURL(url);
  });
  exportBtn.addEventListener('click', () => {
    const payload = {
      product: {
        type: productType.value || null,
        name: productName.value || null,
        subtype: productSubType.value || null
      },
      ingredients: collectIngredients()
    };
    const pretty = JSON.stringify(payload, null, 2);
    jsonOutput.value = pretty;
    const blob = new Blob([pretty], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = "scan.json"; a.click();
    URL.revokeObjectURL(url);
  });

  function escapeCsv(s){ if(/[,\"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`; return s; }

})();
</script>
</body>
</html>
