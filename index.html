<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Étiquettes Boissons — OFF d'abord (v4)</title>
  <meta name="theme-color" content="#4b6cb7"/>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .container{background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);width:100%;max-width:1200px;overflow:hidden}
    header{background:linear-gradient(90deg,#4b6cb7 0%,#182848 100%);color:#fff;padding:22px;text-align:center}
    h1{font-size:1.9rem;margin-bottom:6px}
    .subtitle{opacity:.9}
    .main{padding:18px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
    .tab{border:1px solid #4b6cb7;color:#4b6cb7;background:#f8f9ff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .tab.active{background:#4b6cb7;color:#fff}
    .panel{display:none}
    .panel.active{display:block}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:14px;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .image{width:100%;max-height:380px;object-fit:contain;border-radius:10px;border:1px solid #eee}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{border:none;border-radius:999px;padding:10px 16px;font-weight:600;cursor:pointer}
    .btn-p{background:linear-gradient(90deg,#4b6cb7 0%,#182848 100%);color:#fff}
    .btn-o{background:#fff;border:2px solid #4b6cb7;color:#4b6cb7}
    .small{font-size:.9rem;color:#555}
    .list{list-style:none;background:#f8f9ff;border-radius:10px;padding:10px}
    .row{display:flex;gap:10px;align-items:center;border-bottom:1px solid #e9e9ee;padding:8px 6px}
    .row:last-child{border-bottom:none}
    .pill{font-size:.75rem;padding:2px 8px;border-radius:999px;border:1px solid #ddd}
    .pill-danger{border-color:#b40000;color:#b40000;background:#ffe9e9}
    .pill-warn{border-color:#8a7600;color:#8a7600;background:#fff7d6}
    input[type="text"],textarea,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
    footer{text-align:center;padding:12px;border-top:1px solid #eee;color:#666}
    canvas{max-width:100%}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;text-align:left;padding:8px}
    th{background:#f6f7ff}
    .right{justify-content:flex-end}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    .toggle{display:inline-flex;align-items:center;gap:8px}
  </style>
  <!-- OCR + Barcode libs -->
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
</head>
<body>
<div class="container">
  <header>
    <h1>Étiquettes Boissons</h1>
    <p class="subtitle">Priorité à OpenFoodFacts (code-barres ou recherche nom) puis vérif manuelle/OCR (v4)</p>
  </header>

  <div class="main">
    <div class="tabs">
      <button class="tab active" data-tab="barcode">OFF d'abord</button>
      <button class="tab" data-tab="ocr">OCR</button>
      <button class="tab" data-tab="manuel">Manuel</button>
      <button class="tab" data-tab="historique">Historique</button>
    </div>

    <!-- OFF Panel -->
    <div class="panel active" id="panel-barcode">
      <div class="grid">
        <div class="card">
          <h3>Scanner code-barres</h3>
          <video id="bvideo" class="image"></video>
          <div class="controls">
            <button class="btn btn-p" id="start-scan">Démarrer</button>
            <button class="btn btn-o" id="stop-scan">Arrêter</button>
          </div>
          <div class="small">EAN-13 / UPC-A (caméra arrière recommandée).</div>
        </div>
        <div class="card">
          <h3>Recherche par code ou par nom</h3>
          <input type="text" id="search-input" placeholder="ex: 3274080005003 ou 'Chimay Bleue'"/>
          <div class="controls">
            <button class="btn btn-p" id="search-btn">Chercher sur OFF</button>
            <button class="btn btn-o" id="use-ocr-image">Lire code-barres sur l'image</button>
          </div>
          <div class="small">Si vous avez déjà une photo, “Lire code-barres sur l'image” tentera d’extraire l’EAN à partir de l’onglet OCR &gt; Image.</div>
        </div>
      </div>
    </div>

    <!-- OCR Panel -->
    <div class="panel" id="panel-ocr">
      <div class="grid">
        <div class="card">
          <h3>Image</h3>
          <img id="img" class="image" alt="aperçu"/>
          <video id="vid" class="image" style="display:none" autoplay playsinline></video>
          <div class="controls">
            <input type="file" id="file" accept="image/*" hidden/>
            <button class="btn btn-p" id="pick">Importer</button>
            <button class="btn btn-o" id="camera">Caméra</button>
            <button class="btn btn-o" id="crop">Zone “Ingrédients”</button>
            <button class="btn btn-o" id="reset">Réinitialiser</button>
          </div>
        </div>

        <div class="card">
          <h3>Pré-traitement & OCR</h3>
          <div class="controls">
            <label class="small"><input type="checkbox" id="bw"> Noir & blanc</label>
            <label class="small"><input type="checkbox" id="sh"> Netteté</label>
          </div>
          <div class="controls">
            <button class="btn btn-p" id="run">Lancer l’OCR</button>
          </div>
          <canvas id="canvas" style="display:none"></canvas>
          <pre id="raw" class="small" style="max-height:140px;overflow:auto;background:#fafafa;border:1px solid #eee;padding:8px;border-radius:8px"></pre>
        </div>
      </div>
    </div>

    <!-- Manuel Panel -->
    <div class="panel" id="panel-manuel">
      <div class="card">
        <h3>Coller du texte</h3>
        <textarea id="manual-text" rows="6" placeholder="Collez la zone ingrédients / description produit…"></textarea>
        <div class="controls">
          <button class="btn btn-p" id="parse-manual">Analyser</button>
        </div>
      </div>
    </div>

    <!-- Résultats + Produit -->
    <div class="grid">
      <div class="card">
        <h3>Ingrédients</h3>
        <ul id="list" class="list"></ul>
        <div class="controls">
          <button class="btn btn-o" id="copy">Copier</button>
          <button class="btn btn-o" id="csv">CSV (ce produit)</button>
        </div>
      </div>
      <div class="card">
        <h3>Produit</h3>
        <label>Catégorie</label>
        <select id="ptype">
          <option value="">-- auto --</option>
          <option value="biere">Bière</option>
          <option value="vin">Vin</option>
          <option value="champagne">Champagne</option>
        </select>
        <label style="margin-top:8px">Nom / Marque</label>
        <input type="text" id="pname" placeholder="ex: Chimay Grande Réserve"/>
        <label style="margin-top:8px">Sous-type</label>
        <input type="text" id="psub" placeholder="ex: IPA / Blonde / Rouge / Rosé / Blanc"/>
        <div class="controls" style="margin-top:8px">
          <button class="btn btn-p" id="save">Enregistrer dans l'historique</button>
          <button class="btn btn-o" id="export-json">JSON (ce produit)</button>
        </div>
      </div>
    </div>

    <!-- Historique Panel -->
    <div class="panel" id="panel-historique">
      <div class="card">
        <div class="controls right">
          <button class="btn btn-p" id="export-all-csv">Exporter TOUT en CSV</button>
          <button class="btn btn-o" id="export-all-json">Exporter TOUT en JSON</button>
          <button class="btn btn-o" id="clear-history">Vider l'historique</button>
        </div>
        <table id="history-table">
          <thead>
            <tr>
              <th>Date</th><th>Nom</th><th>Catégorie</th><th>Sous-type</th><th># Ingrédients</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="small">Historique local (localStorage). Priorité OFF, OCR pour vérification.</div>
      </div>
    </div>

  </div>
  <footer>Installable (PWA). OFF d’abord, OCR ensuite pour corriger/compléter.</footer>
</div>

<script>
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
function capitalize(s){ return s? s.charAt(0).toUpperCase()+s.slice(1):s; }
function normWS(s){ return (s||"").replace(/\r?\n/g," ").replace(/\s{2,}/g," ").trim(); }
function escapeCsv(s){ return /[,"\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s; }
function fmtDate(ts){ const d=new Date(ts); return d.toLocaleString(); }

const ALLERGENES = ["gluten","lait","lactose","œuf","oeuf","arachide","soja","noisette","amande","noix","noix de cajou","pistache","noix de pécan","sulfites","crustacé","crustacés","moutarde","céleri","graines de sésame","sésame","lupin","poisson","mollusque","mollusques"];
const KEYS_PRODUCT = {
  biere: [/bi[eè]re\b/i, /\bbeer\b/i, /\bipa\b/i, /\bstout\b/i, /\bblonde\b/i, /\bbrune\b/i, /\btriple\b/i, /\blager\b/i, /\bpils?\b/i],
  vin: [/\bvin\b/i, /\bappellation\b/i, /\b(aoc|aop|igp)\b/i, /\bch[âa]teau\b/i, /\bc[ée]pages?\b/i],
  champagne: [/\bchampagne\b/i, /\bgrand cru\b/i, /\bbrut\b/i, /\bblanc de blancs\b/i]
};
const KEYS_SUBTYPE = {
  biere: [["ipa",/\bipa\b/i],["blonde",/\bblonde\b/i],["brune",/\bbrune\b/i],["ambrée",/\bambr[ée]e?\b/i],["stout",/\bstout\b/i],["triple",/\btriple\b/i],["pale ale",/\bpale ale\b/i]],
  vin: [["rouge",/\brouge\b/i],["rosé",/\bros[ée]\b/i],["blanc",/\bblanc\b/i],["moelleux",/\bmoelleux\b/i],["sec",/\bsec\b/i]],
  champagne: [["brut",/\bbrut\b/i],["extra brut",/\bextra\s+brut\b/i],["rosé",/\bros[ée]\b/i],["blanc de blancs",/\bblanc de blancs\b/i],["demi-sec",/\bdemi-?sec\b/i]]
};

// Tabs
$$('.tab').forEach(t=>t.addEventListener('click', ()=>{
  $$('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const id = t.dataset.tab;
  $$('.panel').forEach(p=>p.classList.remove('active'));
  $('#panel-'+id).classList.add('active');
  if(id==='historique') renderHistory();
}));

// ===== OFF: code-barres + recherche nom =====
let codeReader = null;
$('#start-scan').onclick = async()=>{
  try{
    const { BrowserMultiFormatReader } = ZXingBrowser;
    if(!codeReader) codeReader = new BrowserMultiFormatReader();
    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    const back = devices.find(d=>/back|rear|environment/i.test(d.label))?.deviceId || devices[0]?.deviceId;
    await codeReader.decodeFromVideoDevice(back, $('#bvideo'), (res)=>{
      if(res){ $('#bvideo').style.border='2px solid #3cb371'; fetchOFFByCode(res.getText()); }
    });
  }catch(e){ alert('Scanner indisponible'); console.error(e); }
};
$('#stop-scan').onclick = ()=>{ if(codeReader){ codeReader.reset(); } };

$('#search-btn').onclick = ()=>{
  const q = $('#search-input').value.trim();
  if(!q) return;
  if(/^\d{8,14}$/.test(q)) fetchOFFByCode(q);
  else fetchOFFByName(q);
};

// Lire code-barres sur l'image déjà importée en OCR
$('#use-ocr-image').onclick = async()=>{
  const img = document.getElementById('img');
  if(!img || !img.src) return alert("Chargez d'abord une image dans l'onglet OCR.");
  try{
    const res = await ZXingBrowser.BrowserBarcodeReader.decodeFromImage(null, img);
    if(res && res.getText){ fetchOFFByCode(res.getText()); }
    else alert('Aucun code-barres détecté sur l’image.');
  }catch(e){ alert('Échec de lecture du code-barres sur image.'); console.error(e); }
};

async function fetchOFFByCode(code){
  try{
    const r = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
    const j = await r.json();
    if(j && j.product){
      fillFromOFF(j.product);
    }else{
      alert('Produit introuvable via ce code.');
    }
  }catch(e){ alert('Erreur OFF'); console.error(e); }
}
async function fetchOFFByName(name){
  try{
    // Recherche simple OFF
    const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(name)}&search_simple=1&json=1&page_size=1`;
    const r = await fetch(url);
    const j = await r.json();
    if(j && j.products && j.products.length){
      fillFromOFF(j.products[0]);
    }else{
      alert('Aucun produit trouvé pour ce nom.');
    }
  }catch(e){ alert('Erreur OFF'); console.error(e); }
}

function fillFromOFF(p){
  const ing = p.ingredients_text_fr || p.ingredients_text || '';
  handleText(ing || '');
  $('#pname').value = p.product_name_fr || p.product_name || $('#pname').value;
  const cats = (p.categories_tags || []).join(' ') + ' ' + (p.categories || '');
  if(/beer|bi[eè]re/i.test(cats)) $('#ptype').value = 'biere';
  else if(/champagne/i.test(cats)) $('#ptype').value = 'champagne';
  else if(/vin|wine/i.test(cats)) $('#ptype').value = 'vin';
  const txt = [p.labels_fr,p.labels_tags,p.brands,p.generic_name_fr,p.ingredients_text_fr].filter(Boolean).join(' ');
  autoSubtypeFromText(txt);
  updateCurrentPayload();
  alert('Données OpenFoodFacts chargées. Vérifiez et corrigez si besoin.');
}

// ===== OCR (pour vérif/complément) =====
let stream = null;
let cropRect = null;
const imgEl = $('#img'), vid = $('#vid'), canvas = $('#canvas'), raw = $('#raw');
const ctx = canvas.getContext('2d');

$('#pick').onclick = ()=> $('#file').click();
$('#file').onchange = (e)=>{
  if(!e.target.files.length) return;
  const file = e.target.files[0];
  if(!file.type.startsWith('image/')) return alert('Image invalide');
  const url = URL.createObjectURL(file);
  stopCamera();
  imgEl.src = url; imgEl.style.display='block'; vid.style.display='none';
};
$('#camera').onclick = async()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    vid.srcObject = stream; vid.style.display='block'; imgEl.style.display='none';
  }catch(e){ alert('Caméra indisponible'); }
};
$('#reset').onclick = ()=>{ stopCamera(); imgEl.src=''; vid.srcObject=null; raw.textContent=''; cropRect=null; };
function stopCamera(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
$('#crop').onclick = ()=>{ alert('Desktop: cliquez-glissez sur l’image pour définir la zone ingrédients.'); };
let isDragging=false, startX=0, startY=0;
imgEl.addEventListener('mousedown',(e)=>{ isDragging=true; startX=e.offsetX; startY=e.offsetY; });
imgEl.addEventListener('mouseup',(e)=>{ if(!isDragging) return; isDragging=false; cropRect = { x:Math.min(startX,e.offsetX), y:Math.min(startY,e.offsetY), w:Math.abs(e.offsetX-startX), h:Math.abs(e.offsetY-startY) }; alert('Zone définie. OCR possible.'); });

async function drawToCanvas(){
  return new Promise((resolve)=>{
    const source = vid.style.display==='block' ? vid : imgEl;
    if(!source || (!source.src && source!==vid)) return resolve(false);
    const w = source.videoWidth || source.naturalWidth, h = source.videoHeight || source.naturalHeight;
    if(!w||!h) return resolve(false);
    canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(source,0,0,w,h);
    resolve(true);
  });
}
function preprocess({bw, sh}){
  const ctx = canvas.getContext('2d');
  let imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
  let d = imgData.data;
  if(cropRect){
    const w=canvas.width,h=canvas.height;
    const dispW = imgEl.clientWidth, dispH = imgEl.clientHeight;
    const scaleX = w/dispW, scaleY = h/dispH;
    const sx = Math.max(0, Math.floor(cropRect.x*scaleX));
    const sy = Math.max(0, Math.floor(cropRect.y*scaleY));
    const sw = Math.min(w-sx, Math.floor(cropRect.w*scaleX));
    const shh= Math.min(h-sy, Math.floor(cropRect.h*scaleY));
    const tmp = ctx.getImageData(sx,sy,sw,shh);
    canvas.width=sw; canvas.height=shh;
    ctx.putImageData(tmp,0,0);
    imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    d = imgData.data;
  }
  // grayscale
  for(let i=0;i<d.length;i+=4){
    const y = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
    d[i]=d[i+1]=d[i+2]=y;
  }
  if(bw){
    // simple Otsu-like threshold
    let hist = new Array(256).fill(0);
    for(let i=0;i<d.length;i+=4) hist[d[i]|0]++;
    let sum=0; for(let t=0;t<256;t++) sum+=t*hist[t];
    let sumB=0,wB=0,wF=0,max=0,th=127;
    const total = canvas.width*canvas.height;
    for(let t=0;t<256;t++){
      wB += hist[t]; if(!wB) continue;
      wF = total - wB; if(!wF) break;
      sumB += t*hist[t];
      const mB=sumB/wB, mF=(sum-sumB)/wF;
      const between = wB*wF*(mB-mF)*(mB-mF);
      if(between>max){ max=between; th=t; }
    }
    for(let i=0;i<d.length;i+=4){ const v = d[i] > th ? 255 : 0; d[i]=d[i+1]=d[i+2]=v; }
  }
  if(sh){
    const copy = new Uint8ClampedArray(d);
    const w = canvas.width, h = canvas.height;
    const idx = (x,y)=>4*(y*w+x);
    const k = [-1,-1,-1,-1,9,-1,-1,-1,-1];
    for(let y=1;y<h-1;y++){
      for(let x=1;x<w-1;x++){
        let acc=0, ki=0;
        for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
          acc += copy[idx(x+dx,y+dy)]*k[ki++];
        }
        const i = idx(x,y);
        const v = Math.max(0,Math.min(255,acc));
        d[i]=d[i+1]=d[i+2]=v;
      }
    }
  }
  ctx.putImageData(imgData,0,0);
}

$('#run').onclick = async()=>{
  const ok = await drawToCanvas(); if(!ok) return alert('Chargez une image ou utilisez la caméra.');
  preprocess({bw: $('#bw').checked, sh: $('#sh').checked});
  const dataUrl = canvas.toDataURL('image/png');
  const worker = await Tesseract.createWorker("fra", 1, { logger: m => {} });
  const { data:{ text } } = await worker.recognize(dataUrl);
  await worker.terminate();
  raw.textContent = text;
  handleText(text);
};

// ===== Manuel =====
$('#parse-manual').onclick = ()=>{ handleText($('#manual-text').value); };

// ===== Parsing commun & produit =====
function splitLines(text){ return (text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean); }

function extractIngredients(rawText){
  if(!rawText) return [];
  let text = normWS(rawText);
  const mks = ["ingrédients","ingredients","composition","ingrédiens"];
  let start = -1;
  for(const m of mks){ const i = text.toLowerCase().indexOf(m); if(i!==-1){ start=i; break; } }
  if(start !== -1){ text = text.slice(start).replace(/^.*?:/i,''); }
  const stops = ["valeurs nutritionnelles","nutritionnelles","peut contenir","traces de","conserver","allergenes","allergènes"];
  for(const s of stops){ const i = text.toLowerCase().indexOf(s); if(i!==-1) text = text.slice(0,i); }
  let s = text.replace(/\r/g," ").replace(/\n/g," ").replace(/\s+/g," ").replace(/\s*[•·\*]\s*/g,", ").replace(/\s*;\s*/g,", ").replace(/\s*\.\s*/g,", ");
  s = s.replace(/[()]/g, ",");
  let parts = s.split(/\s*,\s*/).map(p=>p.trim().toLowerCase())
      .filter(p=>p && p.length<80)
      .map(t=> t.replace(/\b\d+([.,]\d+)?\s*%/g,"").replace(/\b\d+([.,]\d+)?\s*(g|mg|ml)\b/g,"").trim())
      .map(t=> t.replace(/^(ingrédients?|composition)\s*:?\s*/,""));
  const seen = new Set(), out=[];
  for(const p of parts){ const k=p.normalize('NFKC'); if(!seen.has(k) && !/^[\W_]+$/.test(k)){ seen.add(k); out.push(p);} }
  return out;
}

function renderIngredients(items){
  const ul = $('#list'); ul.innerHTML='';
  if(items.length===0){ ul.innerHTML='<li class="row">Aucun ingrédient détecté.</li>'; return; }
  for(const name of items){
    const li = document.createElement('li'); li.className='row';
    const pill = document.createElement('span'); pill.className='pill';
    const allergen = ALLERGENES.find(a=>name.includes(a));
    const maybe = /traces de/.test(name);
    if(allergen){ pill.classList.add('pill-danger'); pill.textContent='Allergène'; }
    else if(maybe){ pill.classList.add('pill-warn'); pill.textContent='Traces possibles'; }
    else pill.textContent='Ingrédient';
    const span = document.createElement('span'); span.textContent = capitalize(name);
    li.appendChild(pill); li.appendChild(span);
    ul.appendChild(li);
  }
}

function autoDetectProduct(lines){
  const text = lines.join(' \n ');
  const score = {biere:0,vin:0,champagne:0};
  for(const [type, regs] of Object.entries(KEYS_PRODUCT)){ regs.forEach(r=>{ if(r.test(text)) score[type]++; }); }
  const best = Object.keys(score).reduce((a,b)=> score[a]>=score[b]?a:b);
  if(score[best]>0 && !$('#ptype').value) $('#ptype').value = best;
  const selected = $('#ptype').value || best;
  if(selected && KEYS_SUBTYPE[selected]){
    for(const [label, rx] of KEYS_SUBTYPE[selected]){ if(rx.test(text) && !$('#psub').value){ $('#psub').value = capitalize(label); break; } }
  }
  const blacklist = ["ingredients","ingrédients","composition","valeurs","nutritionnelles","alcool","degré","volume","mise en bouteille","mis en bouteille"];
  let bestLine = {score:0,text:""};
  for(let i=0;i<Math.min(12, lines.length);i++){
    const L = lines[i], low=L.toLowerCase();
    if(blacklist.some(b=>low.includes(b))) continue;
    if(L.length>=5 && /[A-Za-zÀ-ÖØ-öø-ÿ]/.test(L)){
      const sc = (L===L.toUpperCase()?2:0) + (/\b[A-Z][a-z]/.test(L)?1:0) + Math.min(L.length,40)/40;
      if(sc>bestLine.score){ bestLine={score:sc,text:L.replace(/[\.:]+$/,'').trim()}; }
    }
  }
  if(bestLine.text && !$('#pname').value) $('#pname').value = bestLine.text;
}

function autoSubtypeFromText(text){
  const joined = String(text||"");
  const type = $('#ptype').value;
  const map = KEYS_SUBTYPE[type] || [];
  for(const [label, rx] of map){ if(rx.test(joined)){ $('#psub').value = capitalize(label); break; } }
}

// Common handler
function handleText(text){
  const ings = extractIngredients(text);
  renderIngredients(ings);
  autoDetectProduct(text.split(/\r?\n/));
  updateCurrentPayload();
}

// ===== Current payload & single-product export =====
function collectIngredients(){ return [...$$('#list .row span:last-child')].map(x=>x.textContent); }
function currentProduct(){
  return { product: { type: $('#ptype').value || null, name: $('#pname').value || null, subtype: $('#psub').value || null }, ingredients: collectIngredients(), ts: Date.now() };
}
function updateCurrentPayload(){ window.__current = currentProduct(); }

$('#copy').onclick = async()=>{ try{ await navigator.clipboard.writeText(collectIngredients().join(', ')); }catch(e){ alert('Copie impossible'); } };
$('#csv').onclick = ()=>{ const rows=[["ingredient","type"]]; $$('#list .row').forEach(li=>{ const name=li.querySelector('span:last-child')?.textContent||""; const type=li.querySelector('.pill')?.textContent||"Ingrédient"; rows.push([name,type]); }); const csv = rows.map(r=>r.map(escapeCsv).join(",")).join("\n"); const blob = new Blob([csv], {type:"text/csv"}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ingredients.csv'; a.click(); URL.revokeObjectURL(url); };
$('#export-json').onclick = ()=>{ const payload=currentProduct(); const pretty=JSON.stringify(payload,null,2); const blob=new Blob([pretty],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='scan.json'; a.click(); URL.revokeObjectURL(url); };

// ===== Historique (localStorage) =====
const KEY = 'labels_history_v1';
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY) || '[]'); }catch{ return []; } }
function saveHistory(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
function addToHistory(entry){
  const hist = loadHistory(); hist.push(entry); saveHistory(hist); renderHistory(); alert('Enregistré.'); }
function deleteFromHistory(idx){ const hist = loadHistory(); hist.splice(idx,1); saveHistory(hist); renderHistory(); }
function clearHistory(){ if(!confirm('Supprimer tout l’historique ?')) return; localStorage.removeItem(KEY); renderHistory(); }
function renderHistory(){
  const tbody = $('#history-table tbody');
  const hist = loadHistory(); tbody.innerHTML='';
  if(hist.length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="6" style="text-align:center;color:#666">Aucun enregistrement.</td>'; tbody.appendChild(tr); return; }
  hist.forEach((p,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${fmtDate(p.ts||Date.now())}</td><td>${escapeHtml(p.product?.name||'')}</td><td>${escapeHtml(p.product?.type||'')}</td><td>${escapeHtml(p.product?.subtype||'')}</td><td>${(p.ingredients||[]).length}</td><td><button class="btn btn-o" data-del="${idx}">Supprimer</button></td>`;
    tbody.appendChild(tr);
  });
  $$('#history-table [data-del]').forEach(btn=> btn.addEventListener('click', ()=> deleteFromHistory(parseInt(btn.getAttribute('data-del')))));
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

$('#save').onclick = ()=>{ const payload = currentProduct(); if(!payload.product.name && payload.ingredients.length===0){ return alert('Aucun contenu à enregistrer.'); } addToHistory(payload); };
$('#export-all-csv').onclick = ()=>{ const hist = loadHistory(); const rows = [["date","nom","categorie","sous_type","ingredients"]]; hist.forEach(p=>{ rows.push([fmtDate(p.ts||Date.now()), p.product?.name||"", p.product?.type||"", p.product?.subtype||"", (p.ingredients||[]).join(" | ")]); }); const csv = rows.map(r=>r.map(escapeCsv).join(",")).join("\n"); const blob = new Blob([csv], {type:"text/csv"}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='historique_produits.csv'; a.click(); URL.revokeObjectURL(url); };
$('#export-all-json').onclick = ()=>{ const hist = loadHistory(); const pretty = JSON.stringify(hist, null, 2); const blob = new Blob([pretty], {type:"application/json"}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='historique_produits.json'; a.click(); URL.revokeObjectURL(url); };
$('#clear-history').onclick = clearHistory;

// SW
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./service-worker.js')); }
</script>
</body>
</html>
